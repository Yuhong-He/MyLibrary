<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>按书名找书</title>
    <script type="text/javascript" src="../JavaScript/common.js"></script>
    <script type="text/javascript" src="../JavaScript/generalFunctions.js"></script>
    <script>
        let display_rows = 10;
        let title_sort_verify = 0;
        let author_sort_verify = 0;
        let publisher_sort_verify = 0;
        let year_sort_verify = 0;
        let sort_by_column = "id";
        let sort_order = "desc";
        let lang = "zh";
        let search_value = "";
        $(document).ready(function(){
            $("#headerContent").load("header.html");
            $("#footerContent").load("footer.html");
            setTimeout(() => navBlockColor(), 50);
            to_page(1);
            displayAfterLoad();
            setTimeout(() => autoFooter(), 50);
        });

        function navBlockColor() {
            document.getElementById('nav_books').className += ' active';
            document.getElementById('nav_search').className += 'active';
            document.getElementById('display_10_rows').className += 'active';
        }

        function rows_5_selected() {
            display_rows = 5;
            to_page(1);
            document.getElementById('display_5_rows').className = 'active';
            document.getElementById('display_10_rows').className = 'inactive';
            document.getElementById('display_20_rows').className = 'inactive';
            document.getElementById('display_50_rows').className = 'inactive';
        }

        function rows_10_selected() {
            display_rows = 10;
            to_page(1);
            document.getElementById('display_5_rows').className = 'inactive';
            document.getElementById('display_10_rows').className = 'active';
            document.getElementById('display_20_rows').className = 'inactive';
            document.getElementById('display_50_rows').className = 'inactive';
        }

        function rows_20_selected() {
            display_rows = 20;
            to_page(1);
            document.getElementById('display_5_rows').className = 'inactive';
            document.getElementById('display_10_rows').className = 'inactive';
            document.getElementById('display_20_rows').className = 'active';
            document.getElementById('display_50_rows').className = 'inactive';
        }

        function rows_50_selected() {
            display_rows = 50;
            to_page(1);
            document.getElementById('display_5_rows').className = 'inactive';
            document.getElementById('display_10_rows').className = 'inactive';
            document.getElementById('display_20_rows').className = 'inactive';
            document.getElementById('display_50_rows').className = 'active';
        }

        function to_page(pn) {
            build_books_table(pn);
            build_page_info();
            build_page_nav(pn);
        }

        function build_books_table(pn){
            $.ajax({
                url:"../PHP/allBooks.php",
                method:"GET",
                data:{
                    page: pn,
                    rows: display_rows,
                    sortByColumn: sort_by_column,
                    sortOrder: sort_order,
                    lang: lang,
                    search: search_value
                },
                success:function(result){
                    document.getElementById("all_books_table_body").innerHTML=result;
                }
            });
        }

        function build_page_info(){
            $.ajax({
                url:"../PHP/getPageInfo.php",
                method:"GET",
                data:{
                    rows: display_rows,
                    table: "books",
                    column: "Title",
                    search: search_value
                },
                success:function(result){
                    document.getElementById("page_info_area").innerHTML=result;
                }
            });
        }

        function build_page_nav(pn){
            $.ajax({
                url:"../PHP/buildPageNav.php",
                method:"GET",
                data:{
                    page: pn,
                    rows: display_rows,
                    table: "books",
                    column: "Title",
                    search: search_value
                },
                success:function(result){
                    document.getElementById("page_nav_area").innerHTML=result;
                }
            });
        }

        function book_title_sort() {
            document.getElementById('book_author_sort').src='../Resources/image/sort-solid.svg';
            document.getElementById('book_publisher_sort').src='../Resources/image/sort-solid.svg';
            document.getElementById('book_year_sort').src='../Resources/image/sort-solid.svg';
            if(title_sort_verify === 0){
                sort_by_column = "Title";
                sort_order = "desc";
                document.getElementById('book_title_sort').src='../Resources/image/sort-down-solid.svg';
                title_sort_verify = 1;
            } else if(title_sort_verify === 1){
                sort_by_column = "Title";
                sort_order = "asc";
                document.getElementById('book_title_sort').src='../Resources/image/sort-up-solid.svg';
                title_sort_verify = 0;
            }
            to_page(1);
        }

        function book_author_sort() {
            document.getElementById('book_title_sort').src='../Resources/image/sort-solid.svg';
            document.getElementById('book_publisher_sort').src='../Resources/image/sort-solid.svg';
            document.getElementById('book_year_sort').src='../Resources/image/sort-solid.svg';
            if(author_sort_verify === 0){
                sort_by_column = "Author";
                sort_order = "desc";
                document.getElementById('book_author_sort').src='../Resources/image/sort-down-solid.svg';
                author_sort_verify = 1;
            } else if(author_sort_verify === 1){
                sort_by_column = "Author";
                sort_order = "asc";
                document.getElementById('book_author_sort').src='../Resources/image/sort-up-solid.svg';
                author_sort_verify = 0;
            }
            to_page(1);
        }

        function book_publisher_sort() {
            document.getElementById('book_title_sort').src='../Resources/image/sort-solid.svg';
            document.getElementById('book_author_sort').src='../Resources/image/sort-solid.svg';
            document.getElementById('book_year_sort').src='../Resources/image/sort-solid.svg';
            if(publisher_sort_verify === 0){
                sort_by_column = "Publisher";
                sort_order = "desc";
                document.getElementById('book_publisher_sort').src='../Resources/image/sort-down-solid.svg';
                publisher_sort_verify = 1;
            } else if(publisher_sort_verify === 1){
                sort_by_column = "Publisher";
                sort_order = "asc";
                document.getElementById('book_publisher_sort').src='../Resources/image/sort-up-solid.svg';
                publisher_sort_verify = 0;
            }
            to_page(1);
        }

        function book_year_sort() {
            document.getElementById('book_title_sort').src='../Resources/image/sort-solid.svg';
            document.getElementById('book_author_sort').src='../Resources/image/sort-solid.svg';
            document.getElementById('book_publisher_sort').src='../Resources/image/sort-solid.svg';
            if(year_sort_verify === 0){
                sort_by_column = "Year";
                sort_order = "desc";
                document.getElementById('book_year_sort').src='../Resources/image/sort-down-solid.svg';
                year_sort_verify = 1;
            } else if(year_sort_verify === 1){
                sort_by_column = "Year";
                sort_order = "asc";
                document.getElementById('book_year_sort').src='../Resources/image/sort-up-solid.svg';
                year_sort_verify = 0;
            }
            to_page(1);
        }

        function search_book() {
            let search_value_before_clean = document.getElementById('search_box').value;
            search_value = search_value_before_clean.replace(/\'/g, "\\'");
            to_page(1);
        }

        $(document).on("click", ".cite_btn", function(){
            const book_id = $(this).attr("cite-id");
            $.ajax({
                url:"../PHP/citeBook.php",
                method:"GET",
                data:{
                    id: book_id
                },
                success:function(result){
                    document.getElementById("wikipedia_template").innerHTML=result.wikipedia;
                    document.getElementById("gbt7714_2015").innerHTML=result.gbt7714;
                }
            });
            $("#citeBookModal").modal({
                backdrop: "static"
            });
        });

        $(document).on("click", "#wikipedia_copy_button", function(){
            const copied_body = document.getElementById("wikipedia_template").value;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(copied_body);
            }
        });

        $(document).on("click", "#gbt7714_copy_button", function(){
            const copied_body = document.getElementById("gbt7714_2015").value;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(copied_body);
            }
        });
    </script>
</head>
<body>
<!-- Cite Book Model -->
<div class="modal fade" id="citeBookModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">引用书籍</h4>
            </div>
            <div class="modal-body">
                <table style="border: none; width: 100%; border-collapse: separate; border-spacing: 0 10px;">
                    <tr>
                        <td colspan="2"><label for="wikipedia_template">维基百科<a href="https://zh.wikipedia.org/wiki/Template:Cite_book" target="_blank">Cite Book模板</a></label></td>
                    </tr>
                    <tr>
                        <td>
                            <textarea style="min-width: 100%; border: 2px solid #ccc; border-radius: 4px; background-color: #f8f8f8; resize:none;" id="wikipedia_template" readonly></textarea>
                        </td>
                        <td style="text-align: center">
                            <a tabindex="0" class="btn btn-primary" role="button" data-toggle="popover" data-placement="top" data-trigger="focus" data-content=复制成功 id="wikipedia_copy_button">复制</a>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2"><label for="gbt7714_2015">参考文献著录规则（GB/T 7714－2015）</label></td>
                    </tr>
                    <tr>
                        <td>
                            <textarea style="min-width: 100%; border: 2px solid #ccc; border-radius: 4px; background-color: #f8f8f8; resize:none;" id="gbt7714_2015" readonly></textarea>
                        </td>
                        <td style="text-align: center">
                            <a tabindex="0" class="btn btn-primary" role="button" data-toggle="popover" data-placement="top" data-trigger="focus" data-content=复制成功 id="gbt7714_copy_button">复制</a>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!--Main Body-->
<div id="headerContent"></div>
<div class="container">
    <div class="row" style="font-size: 1.2em;font-family: STXingkai,serif;">
        <div class="col-md-12">
            <h2>按书名找书</h2>
        </div>
    </div>
    <div class="row" style="padding-top: 1%">
        <div class="col-xs-5 col-sm-5 col-md-5">
            <input type="text" class="form-control" placeholder="搜索书名" id="search_box" oninput="search_book()">
        </div>
        <div class="col-md-2 col-md-offset-0 pull-right">
            <button type="button" class="btn btn-primary" id="add_new_book_btn">新增</button>
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">显示<span class="caret"></span>
                </button>
                <ul class="dropdown-menu" style="min-width:73px">
                    <li id="display_5_rows" onclick="rows_5_selected()"><a href="#">5行</a></li>
                    <li id="display_10_rows" onclick="rows_10_selected()"><a href="#">10行</a></li>
                    <li id="display_20_rows" onclick="rows_20_selected()"><a href="#">20行</a></li>
                    <li id="display_50_rows" onclick="rows_50_selected()"><a href="#">50行</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="row" style="padding-top: 2%">
        <div class="col-md-12">
            <table class="table table-hover" style="table-layout: fixed; word-break: break-all" id="books_table">
                <thead>
                    <tr>
                        <th style="cursor: pointer; width: 30%;" onclick="book_title_sort()">
                            题名
                            <img src="../Resources/image/sort-solid.svg" id="book_title_sort" width="13" style="float: right" alt="Sort Icon">
                        </th>
                        <th style="cursor: pointer; width: 20%;" onclick="book_author_sort()">
                            作者
                            <img src="../Resources/image/sort-solid.svg" id="book_author_sort" width="13" style="float: right" alt="Sort Icon">
                        </th>
                        <th style="cursor: pointer; width: 10%;" onclick="book_publisher_sort()">
                            出版社
                            <img src="../Resources/image/sort-solid.svg" id="book_publisher_sort" width="13" style="float: right" alt="Sort Icon">
                        </th>
                        <th style="cursor: pointer; width: 7%;" onclick="book_year_sort()">
                            年份
                            <img src="../Resources/image/sort-solid.svg" id="book_year_sort" width="13" style="float: right" alt="Sort Icon">
                        </th>
                        <th style="width: 20%;">分类</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="all_books_table_body"></tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-3">
            <div id="page_info_area" style="padding-top: 10%"></div>
        </div>
        <div class="col-xs-8">
            <div class="pull-right" id="page_nav_area"></div>
        </div>
    </div>
</div>
</body>
<div id="footerContent"></div>
</html>