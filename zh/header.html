<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="../Assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="../Assets/js/jquery-3.6.0.min.js"></script>
    <script src="../Assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://kit.fontawesome.com/5badc55ad0.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="../Assets/common/cookie.js"></script>
    <script type="text/javascript" src="../Assets/common/generalFunctions.js"></script>
    <title>Header Navigate Bar</title>
    <script>
        $("#loginLogout_btn").click(function() {
            const username = getCookie("username");
            if(username===""){
                login();
            } else {
                logout();
            }
        });

        function login(){
            reset_form("#loginModel form");
            $("#loginModel").modal({
                backdrop:"static"
            });
        }

        function validate_login_form() {
            const userName = $("#userName_input").val();
            if(userName === ""){
                show_validate_msg("#userName_input", "error", "请输入用户名");
                return false;
            } else {
                show_validate_msg("#userName_input", "success", "");
            }
            const password = $("#password_input").val();
            if(password === ""){
                show_validate_msg("#password_input", "error", "请输入密码");
                return false;
            } else {
                show_validate_msg("#password_input", "success", "");
            }
            return true;
        }

        $("#model_login_btn").click(function() {
            if(!validate_login_form()){
                return false;
            }
            const userName = $("#userName_input").val();
            const password = $("#password_input").val();
            $.ajax({
                url:"php/login.php",
                method:"POST",
                data:{
                    username: userName,
                    password: password
                },
                success:function(result){
                    if(result.code === 200) {
                        setCookie(userName, password, result.email, result.authority);
                        checkLoginAndDisplay();
                        $("#loginModel").modal('hide');
                    } else {
                        if(result.code === 201){
                            show_validate_msg("#password_input", "error", result.message);
                        } else if(result.code === 400) {
                            show_validate_msg("#userName_input", "error", result.message);
                        }
                    }
                }
            });
        });

        function logout() {
            $("#logoutModel").modal({
                backdrop:"static"
            });
        }

        $("#confirm_logout_btn").click(function(){
            const username = getCookie("username");
            $.ajax({
                url:"php/logout.php",
                method:"POST",
                data:{
                    username: username
                },
                success:function(){
                    const username = getCookie("username");
                    destroyCookie(username);
                    checkLoginAndDisplay();
                    window.location.replace("index.html");
                }
            });
        });

        $("#username_btn").click(function() {
            window.location.replace("profile.html");
        });

        $("#signup_btn").click(function() {
            reset_form("#registerModel form");
            $("#registerModel").modal({
                backdrop:"static"
            });
        });

        function validate_register_form(userName, password, passwordRepeat, email) {
            const regName = /(^[a-zA-Z]{3,16}$)/;
            if(userName===""||userName===null){
                show_validate_msg("#userName_register", "error", "请输入用户名");
                return false;
            } else if(!regName.test(userName)){
                show_validate_msg("#userName_register", "error", "用户名只能是3-16位英文");
                return false;
            } else {
                show_validate_msg("#userName_register", "success", "");
            }
            if(password.length < 5){
                show_validate_msg("#password_register", "error", "密码至少有五位");
                return false;
            } else {
                show_validate_msg("#password_register", "success", "");
            }
            if(password!==passwordRepeat){
                show_validate_msg("#password_register_repeat", "error", "密码不一致");
                return false;
            } else {
                show_validate_msg("#password_register_repeat", "success", "");
            }
            const regEmail = /^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/;
            if(email === ""){
                show_validate_msg("#email_register", "error", "请输入邮箱");
                return false;
            } else if (!regEmail.test(email)){
                show_validate_msg("#email_register", "error", "邮箱格式不正确")
                return false;
            } else {
                show_validate_msg("#email_register", "success", "")
            }
            return true;
        }

        $("#model_register_btn").click(function() {
            const userName = $("#userName_register").val();
            const password = $("#password_register").val();
            const passwordRepeat = $("#password_register_repeat").val();
            const email = $("#email_register").val();
            if(!validate_register_form(userName, password, passwordRepeat, email)){
                return false;
            }
            $.ajax({
                url:"php/register.php",
                method:"POST",
                data:{
                    username: userName,
                    password: password,
                    email: email
                },
                success:function(result){
                    if(result.code === 200) {
                        setCookie(userName, password, result.email, result.authority);
                        $("#userName_input").val(userName);
                        $("#password_input").val(password);
                        $("#registerModel").modal('hide');
                    } else {
                        if(result.code === 202){
                            show_validate_msg("#userName_register", "error", result.message);
                        }
                    }
                }
            });
        });
    </script>
</head>

<body onload="checkLoginAndDisplay();">
<!--Login Model-->
<div class="modal fade" id="loginModel" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">登录面板</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">用户名</label>
                        <div class="col-sm-10">
                            <input type="text" name="userName" class="form-control" id="userName_input">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">密码</label>
                        <div class="col-sm-10">
                            <input type="password" name="password" class="form-control" id="password_input">
                            <span class="help-block"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="signup_btn" style="float: left">注册</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="model_login_btn">确认</button>
            </div>
        </div>
    </div>
</div>

<!--Register Model-->
<div class="modal fade" id="registerModel" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">注册面板</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">用户名</label>
                        <div class="col-sm-10">
                            <input type="text" name="userName" class="form-control" id="userName_register">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">密码</label>
                        <div class="col-sm-10">
                            <input type="password" name="password" class="form-control" id="password_register">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">再输一次</label>
                        <div class="col-sm-10">
                            <input type="password" name="passwordRepeat" class="form-control" id="password_register_repeat">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">邮箱</label>
                        <div class="col-sm-10">
                            <input type="text" name="email" class="form-control" id="email_register">
                            <span class="help-block"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="model_register_btn">确认</button>
            </div>
        </div>
    </div>
</div>

<!-- Logout Model -->
<div class="modal fade" id="logoutModel" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">确认退出？</h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-danger" id="confirm_logout_btn">退出</button>
            </div>
        </div>
    </div>
</div>

<!--Main Body-->
<div class="container">
    <div class="row" style="margin-top: 2%">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="index.html">
                        <img alt="Brand" src="../Assets/image/logo.jpg" height="20">
                    </a>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1" style="font-size: 1.2em">
                    <ul class="nav navbar-nav">
                        <li id="nav_home"><a href="index.html">首页</a></li>
                        <li class="dropdown" id="nav_books">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true">找书<span class="caret"></span></a>
                            <ul class="dropdown-menu" style="min-width: 68px">
                                <li id="nav_search"><a href="search.php">搜索</a></li>
                                <li id="nav_category"><a href="category.php">按分类</a></li>
                            </ul>
                        </li>
                        <li id="nav_obtain"><a href="obtain.php">互助</a></li>
                        <li class="dropdown" id="nav_manage">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true">管理<span class="caret"></span></a>
                            <ul class="dropdown-menu" style="min-width: 68px">
                                <li id="nav_manage_user"><a href="manageUser.php">管理用户</a></li>
                                <li id="nav_manage_obtain"><a href="manageObtain.php">处理请求</a></li>
                            </ul>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true"><i class="fa-solid fa-language"></i><span class="caret"></span></a>
                            <ul class="dropdown-menu" style="min-width: 68px">
                                <li><a href="../en/index.html">English</a></li>
                            </ul>
                        </li>
                        <li id="nav_profile"><a href="#" id="username_btn"></a></li>
                        <li><a href="#" id="loginLogout_btn"></a></li>
                    </ul>
                </div><!-- /.navbar-collapse -->
            </div><!-- /.container-fluid -->
        </nav>
    </div>
</div>
</body>
</html>